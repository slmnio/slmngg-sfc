<template>
    <div class="mvp-overlay">
        <div v-if="mvp">
            <div class="text-container">
                <div class="break-sponsor-logo bg-center" :style="logo(sponsor)"></div>

                <div class="title-holder">
                    <ThemeTransition
                        start="right"
                        :theme="themeBackground"
                        :active="animationActive"
                        :starting-delay="100"
                        :duration="500">
                        <div class="title" :style="borderColor">{{ title || 'MVP' }}</div>
                    </ThemeTransition>
                </div>

                <div class="text-holder">
                    <ThemeTransition
                        start="right"
                        :theme="themeBackground"
                        :active="animationActive"
                        :starting-delay="400"
                        :duration="300">
                        <div class="player-name-holder" :style="themeBackground">
                            <ThemeLogo icon-padding="20%" border-width="0" :theme="mvpTeam && mvpTeam.theme" class="player-team-logo" />
                            <div class="player-name">{{ mvp.name }}</div>
                        </div>
                    </ThemeTransition>
                </div>
            </div>
            <transition name="hero-move">
                <div v-show="animationActive && mvpTeam && mvpTeam.theme" class="hero-container">
                    <recolored-hero v-if="mvpTeam && mvpTeam.theme" class="hero" :theme="mvpTeam.theme" :hero="hero" />
                </div>
            </transition>
        </div>
    </div>
</template>

<script>
import { ReactiveArray, ReactiveRoot, ReactiveThing } from "@/utils/reactive";
import RecoloredHero from "@/components/broadcast/RecoloredHero";
import ThemeLogo from "@/components/website/ThemeLogo";
import { themeBackground1 } from "@/utils/theme-styles";
import ThemeTransition from "@/components/broadcast/ThemeTransition";
import { useStatusStore } from "@/stores/statusStore";
import { resizedImage } from "@/utils/images";

export default {
    name: "MVPOverlay",
    components: { ThemeTransition, ThemeLogo, RecoloredHero },
    props: ["broadcast", "title", "animationActive", "sponsor"],
    computed: {
        match() {
            return ReactiveRoot(this.broadcast?.live_match?.[0], {
                teams: ReactiveArray("teams", {
                    theme: ReactiveThing("theme")
                }),
                mvp: ReactiveThing("mvp", {
                    member_of: ReactiveArray("member_of", {
                        theme: ReactiveThing("theme")
                    })
                })
            });
        },
        broadcastData() {
            return ReactiveRoot(this.broadcast?.id, {
                highlight_player: ReactiveThing("highlight_player"),
                highlight_team: ReactiveThing("highlight_team", {
                    theme: ReactiveThing("theme")
                })
            });
        },
        mvp() {
            return this.match?.mvp || this.broadcastData?.highlight_player;
        },
        mvpTeam() {
            return this.relatedMvpTeam || this.broadcastData?.highlight_team;
        },
        relatedMvpTeam() {
            if (!this.mvp) return null;
            return (this.mvp.member_of || []).find(team => (this.match?.teams || []).some(t => t.id === team.id));
        },
        hero() {
            return this.broadcast?.highlight_hero || this.mvp?.favourite_hero;
        },
        borderColor() {
            return {
                borderColor: this.mvpTeam?.theme?.color_theme
            };
        },
        themeBackground() {
            return themeBackground1(this.mvpTeam);
        },
        sponsor() {
            if (!this.broadcast?.sponsors) return null;
            return ReactiveArray("sponsors", {
                theme: ReactiveThing("theme"),
            })(this.broadcast)[0];
        },
    },
    methods: {
        logo (theme) {
            return resizedImage(theme, ["default_wordmark", "default_logo"], "h-300");
        },
    },
    watch: {
        mvpTeam: {
            deep: true,
            handler(team) {
                if (team?.theme) {
                    useStatusStore().customStingerTheme = team?.theme;
                }
            }
        }
    },
    head() {
        return {
            title: `MVP | ${this.broadcast?.code || this.broadcast?.name || ""}`
        };
    }
};
</script>

<style scoped>
    .hero-container {
        position: absolute;
        width: 50vw;
        height: 130vh;
        right: -5vw;
        top: -12vh;
    }
    .text-container {
        position: absolute;
        width: 60vw;
        height: 100vh;
        text-align: center;
        justify-content: center;
        align-items: center;
        display: flex;
        flex-direction: column;
    }
    .text-holder {
        min-height: 168px;
    }
    .title-holder {
        min-height: 168px;
    }
    .sponsor-holder {
        padding-top: 80px;
        min-height: 64px;
    }
    .sponsor-name-holder {
        display: flex;
        flex-direction: column;
        border-bottom: 8px solid transparent;
    }
    .sponsor-name {
        display: flex;
        flex-direction: column;
        justify-content: center;
        font-size: 2em;
        padding: 0 0.5em;
    }
    .break-sponsor-logo {
        position: relative;
        width: 300px;
        height: 150px;
    }
    .title {
        display: flex;
        font-size: 6em;
        background-color: #222;
        color: white;
        padding: 0em .5em;
        border-bottom: 8px solid transparent;
        margin-bottom: .5em;
    }
    .player-name-holder {
        display: flex;
    }
    .player-name {
        display: flex;
        flex-direction: column;
        justify-content: center;
        font-size: 5em;
        padding: 0 0.5em;
    }
    .player-name-holder {
        border-bottom: 8px solid transparent;
    }

    .mvp-overlay:deep(.theme-transition),
    .mvp-overlay:deep(.theme-transition-outer),
    .mvp-overlay:deep(.theme-transition-inner) {
        width: auto !important;
        height: auto !important;
    }

    .hero-move-enter-active { transition: all .5s; transform: translate(0%, 0%); transition-delay: 500ms; }
    .hero-move-leave-active { transition: none; }
    .hero-move-enter-from, .hero-move-leave-to { transform: translate(100%, 0%) }
    .hero-move-enter-to, .hero-move-leave-from { transform: translate(0%, 0%) }
</style>
